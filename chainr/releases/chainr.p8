pico-8 cartridge // http://www.pico-8.com
version 29
__lua__
--domino reaction
--by thomas michael wallace

roots={}
ends={}
gaps={}
score=0

ani={
 t=0,--timer
 a=false,--animation frame
 r=8,--animation rate
 o=0,--offset
}

ptr={
 x=64,
 y=64,
 s=2,
}

function add_domino(x,y,g)
	local d={
		x=x,--screen x
	 y=y,--map y
	 s=1,--tl sprite id
	 n={},--next dominos
	 f=false,--falling
	 v=1+flr(rnd(6-1+1)),
	 g=(g or false),-- true if gap
	 k=false,--selected
	 draw=function(self)
	  for n in all(self.n) do
	   n:draw()
	  end
	  local y=(128-8)-(self.y*8)+ani.o
	 	if(self.g)then
	 	 local s=11
	 	 if(self.k)s=12
	 	 spr(s,self.x,y,1,2)
	 	else
	 	 spr(self.s,self.x,y,1,2)
	 	 spr(self.v+4,self.x,y-(self.s-1),1,2)
	  end
	 end,
	 update=function(self)
	  if(not ani.a)return
	 	for n in all(self.n) do
	   n:update()
	  end
	  if(not self.f)return
   if(self.s<4)then
	   self.s+=1
	   if(self.s==3)then
	   	for n in all(self.n) do
		    n:fall()
	    end
	   end
	  end
	 end,
	 fall=function(self)
	  if(self.g)return
	 	self.f=true
	 	score+=self.v
	 	if(score>1000)ani.r=4
	 	if(score>2000)ani.r=2
	 	--if(score>300)ani.r=2
	 end,
	 fwd=function(self,c)
	  if(c==0)then
	   d=add_domino(self.x,self.y+1,true)
	   self.n={d}
	   return self.n
	  end
	  local x=self.x
	 	if(c<=1)then
	 	 x+=rnd(8)-4
	 	else
	 	 x-=((c-1)*8)/2
	 	end
	 	if(x<0)x=0
	 	for i=1,c,1 do
	 	 local d=add_domino(x,self.y+1)
	   x+=8
	   if(x>119)x=119
	   add(self.n,d)
	  end
	  return self.n
	 end,
	 walk=function(self,prop)
	  self.y-=1
	  --end of line
	  if(#self.n==0 and self.y==16 and prop)then
	   local c=1
	   local p=rnd(10)
	   if(p>9)then
	    c=2
	   elseif(p<1)then
	    c=0
	   end
	   --if(c==2)printh("s")
	   local n=self:fwd(c)
	   self.n={}
	   for e in all(n) do
	    --merge
	    local m=false
	    for t in all(ends) do
	     if(e.x>=t.x and e.x<=(t.x+7))then
	      t.x=(e.x+t.x)/2
	      m=true
	     end
	    end
	    --if(m)printh("m")
	    if(not m)then
	     add(self.n,e)
	     add(ends,e)
	    end
	   end
	   return
	  end
	  
	  for n in all(self.n) do
	   n:walk(prop)
	  end
	  
	  --start of line
	  if(self.y==-1)then
	   if(self.g)del(gaps,self)
	 	 return self.n
	 	end
	 	return {self}
	 end,
	 fill=function(self)
	  self.g=false
	  self.k=false
	  del(gaps,self)
	 end
	}
	if(d.g)then
	 add(gaps,d)
	end
	return d
end

function start()
	score=0
	gaps={}
	ani.r=8
 for n=1,1,1 do
	 local n=2
	 local r=add_domino(32*n-8,8)
	 local d=r
	 for y=0,8,1 do
	  d=(d:fwd(1))[1]
	 end
	 r:fall()
	 add(roots,r)
 end
end

function _init()
 --printh("start")
 palt(0,false)
 palt(14,true)
 start()
end

function _update()
 ani.t+=1
 ani.a=ani.t==ani.r
 if(ani.a)then
  ani.t=0
 end
 ani.o+=(4/ani.r)
 
 if(ani.o==8)then
  ani.o=0
  local nr={}
  ends={} --reset
  for r in all(roots) do
   local ws=r:walk(r.f)
   for w in all(ws) do
    add(nr,w)
   end
  end
  roots=nr
 end
 
 for r in all(roots) do
  r:update()
 end
 
 if(btn(0))ptr.x-=ptr.s
 if(btn(1))ptr.x+=ptr.s
 if(btn(2))ptr.y-=ptr.s
 if(btn(3))ptr.y+=ptr.s
 if(ptr.x<4)ptr.x=4
 if(ptr.x>123)ptr.x=123
 if(ptr.y<4)ptr.y=4
 if(ptr.y>123)ptr.y=123

 for g in all(gaps) do
  g.k=false
  if(ptr.x>g.x and ptr.x<(g.x+8))then
   local y=(128-8)-(g.y*8)+ani.o
   if(ptr.y>y and ptr.y<(y+16))then
    g.k=true
   end
  end
  if(btnp(4)or btnp(5)and g.k)then
   g:fill()
  end
 end
 
 if(#roots==0)then
  if(btnp(4)or btnp(5))then
   --printh("reboot")
   start()
  end
 end
end

function printc(t,y,c)
 print(t,64-#t*2,y,c)
end

function _draw()
 cls(1)
 for r in all(roots) do
  r:draw()
 end
 if(#roots==0)then
  printc("game over",53,13)
  printc(tostr(score),61,9)
  printc("press ❎ to replay",69,13)
 else
  print(score)
 end
 spr(16,ptr.x-4,ptr.y-4)
end
__gfx__
00000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee000000000000000000000000
00000000eeeeeeeeeeeeeeeeeeeeeeeee777777eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee000000000000000000000000
00700700eeeeeeeeeeeeeeeee766667ee766667eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee000000000000000000000000
00077000eeeeeeeee777777ee777777ee776667eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee000000000000000000000000
00077000e777777ee766667ee776767ee767667eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeededdedee9e99e9e000000000000000000000000
00700700e766667ee777777ee766677ee776767eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeedeeeedee9eeee9e000000000000000000000000
00000000e777777ee777767ee776767ee777677eeeeeeeeeeeeeeeeeeee05eeeeeeeeeeeee0505eeee0505eeeeeeeeeeeeeeeeee000000000000000000000000
00000000e777777ee777677ee767677ee777767eeeeeeeeeeee05eeeeee00eeeee0505eeee0000eeee0000eeedeeeedee9eeee9e000000000000000000000000
eeeeeeeee777767ee776767ee776777ee777777eeeeeeeeeeee00eeeeeeeeeeeee0000eeeeeeeeeeeeeeeeeeedeeeedee9eeee9e000000000000000000000000
eeeeeeeee777677ee767677ee767777ee777777eeee05eeeeeeeeeeeeee05eeeeeeeeeeeeee05eeeee0505eeeeeeeeeeeeeeeeee000000000000000000000000
eee99eeee776767ee776667ee777777ee766667eeee00eeeeeeeeeeeeee00eeeeeeeeeeeeee00eeeee0000eeedeeeedee9eeee9e000000000000000000000000
ee99a9eee767667ee767677ee766667ee777777eeeeeeeeeeee05eeeeeeeeeeeee0505eeeeeeeeeeeeeeeeeeedeeeedee9eeee9e000000000000000000000000
ee9999eee776667ee777777ee777777eeeeeeeeeeeeeeeeeeee00eeeeee05eeeee0000eeee0505eeee0505eeeeeeeeeeeeeeeeee000000000000000000000000
eee99eeee766667ee766667eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee00eeeeeeeeeeeee0000eeee0000eeedeeeedee9eeee9e000000000000000000000000
eeeeeeeee777777eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeededdedee9e99e9e000000000000000000000000
eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee000000000000000000000000
__label__
66116611677766677771111177705771111111111111111111111111111111111177777711117777777111111111111111111111111111111111111111111111
16111611670565611111111117700771111111111111111111111111111111111d1111d111117777771111111111111111111111111111111111111111111111
16111611666066611111111117777671111111111111111111111111111111111d1111d111117777671111111111111111111111111111111111111111111111
16111611676767611111111117705771111111111111111111111111111111111111111111117705771111111111111111111111111111111111111111111111
66616661666676611111111117700671111111111111111111111111111111111d1111d111117700671111111111111111111111111111111111111111111111
11111111170505711111111117676671111111111111111111111111111111111d1111d111117676671111111111111111111111111111111111111111111111
111111177777707111111111777777711111111111111111111111111111111777777111d1dd7d66671111111111111111111111111111111111111111111111
1111111766667671111111117666677111111111111111111111111111111117666671d1d1117d66671111111111111111111111111111111111111111111111
1111111705057771111111117777777111111111111111111111111111111117050571d111117777771111111111111111111111111111111111111111111111
111111170000711111111111770577111111111111111111111111111111111700007111d1111d11111111111111111111111111111111111111111111111111
111111177776711111111111770067111111111111111111111111111111111777767111d1111d11111111111111111111111111111111111111111111111111
11111117050571111111111177767711111111111111111111111111111111170505711111111111111111111111111111111111111111111111111111111111
111111170000711111111111776767111111111111111111111111111111111700007111d1111d11111111111111111111111111111111111111111111111111
111111176766711111111111760567111111111111111111111111111111111767667111d1111d11111111111111111111111111111111111111111111111111
11111117777771111111777777007777771111111111111111111111111177777705711177777711111111111111111111111111111111111111111111111111
11111117666671111111766667667666671111111111111111111111111176666700711176666711111111111111111111111111111111111111111111111111
11111117705771111111770577777050571111111111111111111111111170505777711177777711111111111111111111111111111111111111111111111111
11111117700771111111770077117000071111111111111111111111111170000711111177777711111111111111111111111111111111111111111111111111
11111117777671111111777767117777671111111111111111111111111177776711111177776711111111111111111111111111111111111111111111111111
11111117705771111111770577117050571111111111111111111111111170505711111177057711111111111111111111111111111111111111111111111111
11111117700671111111770067117000071111111111111111111111111170000711111177006711111111111111111111111111111111111111111111111111
11111117676671111111767667117676671111111111111111111111111176766711111176766711111111111111111111111111111111111111111111111111
1111777777567777771177057777775057111111111111111111111111777777571111117d6dd7d1111111111111111111111111111111111111111111111111
1111766667067666671176007666670007111111111111111111111111766667071111117d6667d1111111111111111111111111111111111111111111111111
11117050577777777711777770505777771111111111111111111111117050577711111177777711111111111111111111111111111111111111111111111111
1111700007117777771111117000071111111111111111111111111111700007111111111d1111d1111111111111111111111111111111111111111111111111
1111777767117777671111117777671111111111111111111111111111777767111111111d1111d1111111111111111111111111111111111111111111111111
11117050571177057711111177057711111111111111111111111111117705771111111111111111111111111111111111111111111111111111111111111111
1111700007117700671111117700671111111111111111111111111111770067111111111d1111d1111111111111111111111111111111111111111111111111
1111767667117676671111117676671111111111111111111111111111767667111111111d1111d1111111111111111111111111111111111111111111111111
11117050777777666711111777777711111111111111111111111111117777777111111117777771111111111111111111111111111111111111111111111111
11117000766667666711111766667711111111111111111111111111117766667111111117666671111111111111111111111111111111111111111111111111
11117777705057777711111777777711111111111111111111111111117777777111111117777771111111111111111111111111111111111111111111111111
11111111700007111111111705057111111111111111111111111111111770577111111117050571111111111111111111111111111111111111111111111111
11111111777767111111111700007111111111111111111111111111111770067111111117000071111111111111111111111111111111111111111111111111
11111111770577111111111777677111111111111111111111111111111777677111111117776771111111111111111111111111111111111111111111111111
11111111770067111111111776767111111111111111111111111111111776767111111117767671111111111111111111111111111111111111111111111111
11111111767667111111111705057111111111111111111111111111111760567111111117050571111111111111111111111111111111111111111111111111
11111177777757111111111777777711111111111111111111111111111777777771111117777771111111111111111111111111111111111111111111111111
11111176666707111111111776666711111111111111111111111111111767666671111117666671111111111111111111111111111111111111111111111111
11111177777777111111111770505711111111111111111111111111111777050571111117050571111111111111111111111111111111111111111111111111
11111177777711111111111170000711111111111111111111111111111117000071111117000071111111111111111111111111111111111111111111111111
11111177776711111111111177776711111111111111111111111111111117777671111117777671111111111111111111111111111111111111111111111111
11111177057711111111111170505711111111111111111111111111111117050571111117705771111111111111111111111111111111111111111111111111
11111177006711111111111170000711111111111111111111111111111117000071111117700671111111111111111111111111111111111111111111111111
11111176766711111111111176766711111111111111111111111111111117676671111117676671111111111111111111111111111111111111111111111111
111111777777111111117777775057d1dd1d111111111111111111111111177777711d1dd7d50571111111111111111111111111111111111111111111111111
111111766667111111117666670007d1111d111111111111111111111111176666711d1117d00071111111111111111111111111111111111111111111111111
11111177057711111111777777777711111111111111111111111111111117705771111117777771111111111111111111111111111111111111111111111111
111111770077111111117050571111d1111d111111111111111111111111177007711d1111d11111111111111111111111111111111111111111111111111111
111111777767111111117000071111d1111d111111111111111111111111177776711d1111d11111111111111111111111111111111111111111111111111111
11111177057711111111777677111111111111111111111111111111111117705771111111111111111111111111111111111111111111111111111111111111
111111770067111111117767671111d1111d111111111111111111111111177006711d1111d11111111111111111111111111111111111111111111111111111
111111767667111111117050571111d1111d111111111111111111111111176766711d1111d11111111111111111111111111111111111111111111111111111
11111177777771111111777777111177777719911111111111111111111117777771177777711111111111111111111111111111111111111111111111111111
11111177666671111111766667111176666799a91111111111111111111117666671176666711111111111111111111111111111111111111111111111111111
11111177777771111111777777111170505799991111111111111111111117050571177057711111111111111111111111111111111111111111111111111111
11111117050571111111777777111170000719911111111111111111111117000071177007711111111111111111111111111111111111111111111111111111
11111117000071111111777767111177776711111111111111111111111117777671177776711111111111111111111111111111111111111111111111111111
11111117776771111111770577111170505711111111111111111111111117705771177057711111111111111111111111111111111111111111111111111111
11111117767671111111770067111170000711111111111111111111111117700671177006711111111111111111111111111111111111111111111111111111
11111117050571111111767667111176766711111111111111111111111117676671176766711111111111111111111111111111111111111111111111111111
11111117077777711777777667111177777711111111111111111111111117050777777056711111111111111111111111111111111111111111111111111111
11111117676666711766667667111176666711111111111111111111111117000766667006711111111111111111111111111111111111111111111111111111
11111117777777711770577777111177057711111111111111111111111117777777777777711111111111111111111111111111111111111111111111111111
11111111170505711770077111111177007711111111111111111111111111111770577111111111111111111111111111111111111111111111111111111111
11111111170000711777767111111177776711111111111111111111111111111770067111111111111111111111111111111111111111111111111111111111
11111111177767711770577111111177057711111111111111111111111111111777677111111111111111111111111111111111111111111111111111111111
11111111177677666670067111176666706711111111111111111111111111117666677111111111111111111111111111111111111111111111111111111111
11111111170507777777667111177777766711111111111111111111111111117777777111111111111111111111111111111111111111111111111111111111
11111111170007050570567111177056756711111111111111111111111111117705677111111111111111111111111111111111111111111111111111111111
11111111176667000070067111176007706711111111111111111111111111117600777111111111111111111111111111111111111111111111111111111111
11111111177777767677777111177676777711111111111111111111111111117767677111111111111111111111111111111111111111111111111111111111
11111111111117605771111111176057711111111111111111111111111111117605771111111111111111111111111111111111111111111111111111111111
11111111111117700771111111177007711111111111111111111111111111117700771111111111111111111111111111111111111111111111111111111111
11111111111777777771111111777777777777711111111111111111111111117777777111111111111111111111111111111111111111111111111111111111
11111111111766667571111111766667776666711111111111111111111111117766667111111111111111111111111111111111111111111111111111111111
11111111111770567071111111705057777056711111111111111111111111117776667111111111111111111111111111111111111111111111111111111111
11111111111760067771111111700007776006711111111111111111111111117705057111111111111111111111111111111111111111111111111111111111
11111111111776767111111111776767177676711111111111111111111111111700007111111111111111111111111111111111111111111111111111111111
11111111111770577111111111770577177057711111111111111111111111111777677111111111111111111111111111111111111111111111111111111111
11111111111770067111111111770067177006711111111111111111111111111777767111111111111111111111111111111111111111111111111111111111
11111111111777777111111111777777177777711111111111111111111111111705057111111111111111111111111111111111111111111111111111111111
11111111111770777777111177777757177777711111111111111111111111777777007777771111111111111111111111111111111111111111111111111111
11111111111760766667111176666707176666711111111111111111111111766667667666671111111111111111111111111111111111111111111111111111
11111111111777705057111177056777177666711111111111111111111111705057777766671111111111111111111111111111111111111111111111111111
11111111111111700007111176006711176766711111111111111111111111700007117676671111111111111111111111111111111111111111111111111111
11111111111111776767111177676711177676711111111111111111111111776767117767671111111111111111111111111111111111111111111111111111
11111111111111770577111177057711177057711111111111111111111111705057117705771111111111111111111111111111111111111111111111111111
11111111111111770067111177006711177006711111111111111111111111700007117700671111111111111111111111111111111111111111111111111111
11111111111111777777111177777711177777711111111111111111111111777777117777771111111111111111111111111111111111111111111111111111
11111111111117777777111177777777177777777711111111111111111117777777177777771111111111111111111111111111111111111111111111111111
11111111111117666677111176766667176676666711111111111111111117666677176666771111111111111111111111111111111111111111111111111111
11111111111117050577111177770567177770505711111111111111111117766677170505771111111111111111111111111111111111111111111111111111
11111111111117000071111111760067111170000711111111111111111117676671170000711111111111111111111111111111111111111111111111111111
11111111111117767671111111776767111177676711111111111111111117767671177676711111111111111111111111111111111111111111111111111111
11111111111117050571111111770577111170505711111111111111111117705771177057711111111111111111111111111111111111111111111111111111
11111111111117000071111111770067111170000711111111111111111117700671177006711111111111111111111111111111111111111111111111111111
11111111111117777771111111777777111177777711111111111111111117777771177777711111111111111111111111111111111111111111111111111111
11111111111117777771111111777777771177777771111111111111111117777777777505711111111111111111111111111111111111111111111111111111
11111111111117666671111111767666671177666671111111111111111117666766667000711111111111111111111111111111111111111111111111111111
11111111111117766671111111777766671177766671111111111111111117777705057777711111111111111111111111111111111111111111111111111111
11111111111117676671111111117050571117050571111111111111111111111700007111111111111111111111111111111111111111111111111111111111
11111111111117767671111111117000071117000071111111111111111111111776767111111111111111111111111111111111111111111111111111111111
11111111111117705771111111117776771117776771111111111111111111111705057111111111111111111111111111111111111111111111111111111111
11111111111117700671111111117777671117777671111111111111111111111700007111111111111111111111111111111111111111111111111111111111
11111111111117777771111111117050571117050571111111111111111111111777777111111111111111111111111111111111111111111111111111111111
11111111111117777777111111177777771777777071111111111111111111177777757111111111111111111111111111111111111111111111111111111111
11111111111117766667111111176666771766667671111111111111111111176666707111111111111111111111111111111111111111111111111111111111
11111111111117770567111111177666771776667771111111111111111111170505777111111111111111111111111111111111111111111111111111111111
11111111111111760067111111176766711767667111111111111111111111170000711111111111111111111111111111111111111111111111111111111111
11111111111111776767111111177676711776767111111111111111111111177676711111111111111111111111111111111111111111111111111111111111
11111111111111770577111111177057711770577111111111111111111111177057711111111111111111111111111111111111111111111111111111111111
11111111111111770067111111177006711770067111111111111111111111177006711111111111111111111111111111111111111111111111111111111111
11111111111111777777111111177777711777777111111111111111111111177777711111111111111111111111111111111111111111111111111111111111
11111111111111777777771111177777777777777111111111111111111111177777711111111111111111111111111111111111111111111111111111111111
11111111111111767666671111176667666676667111111111111111111111176666711111111111111111111111111111111111111111111111111111111111
11111111111111777705671111177777766677777111111111111111111111170505711111111111111111111111111111111111111111111111111111111111
11111111111111117600671111111117676671111111111111111111111111170000711111111111111111111111111111111111111111111111111111111111
11111111111111117767671111111117767671111111111111111111111111177676711111111111111111111111111111111111111111111111111111111111
11111111111111117705771111111117705771111111111111111111111111177057711111111111111111111111111111111111111111111111111111111111
11111111111111117700671111111117700671111111111111111111111111177006711111111111111111111111111111111111111111111111111111111111
11111111111111117777771111111117777771111111111111111111111111177777711111111111111111111111111111111111111111111111111111111111
11111111111111117777771111111117777777771111111111111111111111777777711111111111111111111111111111111111111111111111111111111111
11111111111111117666671111111117667666671111111111111111111111766667711111111111111111111111111111111111111111111111111111111111
11111111111111117050571111111117777766671111111111111111111111705057711111111111111111111111111111111111111111111111111111111111
11111111111111117000071111111111117676671111111111111111111111700007111111111111111111111111111111111111111111111111111111111111
11111111111111117767671111111111117767671111111111111111111111776767111111111111111111111111111111111111111111111111111111111111

