pico-8 cartridge // http://www.pico-8.com
version 27
__lua__
--noodl love
--by thomas michael wallace

game={
 s=nil--current screen
}

function _init()
 --init_title()
 init_game()
end

function _update()
 game.s.u()
end

function _draw()
 game.s.d()
end
-->8
--people

players={}

function m_player(x,y,c)
 local p={
  x=x,--rel. map x
  y=y,--rel. map y
  c=c,--true if n/invert ctrl
  w=false,--true if win
  d=false,--true if die
  t=0,--ticker
  s=0,--noodle eaten
  move=function(_,d)
   if(_.w or _.d)then
    return
   end
   local s=_.c and 1 or -1
   
   local dx=s*d.x
   local dy=s*d.y
   
   local f=-1
   if(dx==-1)f=0
   if(dx==1)f=1
   if(dy==-1)f=2
   if(dy==1)f=3
   
   local mx=_.x+dx+level.mx
   local my=_.y+dy+level.my
   local t=mget(mx,my)
   if fget(t)==0 then
    --empty space
    return
   end
   if fget(t,4) and not fget(t,f) then
    --cross road
    return
   end

   mx-=dx
   my-=dy
   t=mget(mx,my)
   if fget(t,f) then
    --move player
		  _.x+=dx
		  _.y+=dy
    
    if fget(t,7) and t>32 then
     --half double stright
     mset(mx,my,t-32)
    elseif fget(t,4) then
     --clear cross road
     mset(mx,my,t-1)
    else
     --delete tile
     mset(mx,my,0)
    end
    
    _.t=8--trigger animation
    _.s+=1--add to eaten score
   end
  end,
  animate=function(_)
   if(_.t>0)_.t-=1
  end,
  draw=function(_)
   local n=82
   if _.d then
    n=_.c and 69 or 101
    if(_.t>8)n-=1
    if(_.t>0)n-=1
   elseif _.w then
    if(_.t>8)n-=1
    if(_.t>0)n-=1
   else
    n=_.c and 64 or 96
    if(_.t>0)n+=1
   end
   spr(n,_.x*8,_.y*8)
  end,
 }
 return p
end

function update_game()
 --direction
 local d={x=0,y=0}
 if(btnp(0))d.x-=1
 if(btnp(1))d.x+=1
 if(btnp(2))d.y-=1
 if(btnp(3))d.y+=1
 if(d.x~=0 and d.y~=0)d.y=0
 if d.x~=0 or d.y~=0 then
	 for p in all(players) do
	  p:move(d)
	 end
	end
 
 --swap
 if(btnp(4))then
  for p in all(players) do
   p.c=not p.c
  end
 end
 
 --anim
 for p in all(players) do
  p:animate()
 end
 
 check_win()
end

function draw_game()
 cls()
 map(level.mx,level.my,0,0,16,16)
 for p in all(players) do
  p:draw()
 end
 draw_hud()
end
-->8
--noodle

level={mx=0,my=0}

function init_game()
 --recover map
 reload(0x2000,0x2000,0x1000)
 set_map()
 game.s={u=update_game,d=draw_game}
end

function set_map()
 --regenerate players
 players={}
 for mx=level.mx,level.mx+15 do
  for my=level.my,level.my+15 do
   local t=mget(mx,my)
   local c=nil
   if(fget(t,5))c=true
   if(fget(t,6))c=false
   if c~=nil then
    local p=m_player(mx-level.mx,my-level.my,c)
    add(players,p)
   end
  end
 end
end

function check_win()
 --check win
 for p0 in all(players) do
  for p1 in all(players) do
   if p0~=p1 and not p0.w then 
	   if p0.x==p1.x and p0.y==p1.y then
	    p0.w=true
	    p1.w=true
	    p0.t=16
	    p1.t=16
	    mset(p0.x+level.mx,p0.y+level.my,0)
	   end
	  end
	 end
 end
 --check complete
 wins=0
 for p in all(players) do
  if(p.w and p.t==0)wins+=1
 end
 if wins==#players then
  level.mx+=16
  set_map()
 end
end
-->8
--hud

function draw_hud()
 local s=0
 local c=0
 for p in all(players) do
  s+=p.s
  if(p.c)c+=p.s
 end
 
 local n=s-c
 local r=c-(s-c)+8
 if r>15 or r<1 then
  for p in all(players) do
   if not p.d then
	   p.d=true
	   p.t=16
	  end
	  if p.t==0 then
	   init_game()
	   return
	  end
  end
 end
 r=mid(1,r,15)
  
 for i=1,r-1 do
  spr(112,i*8,2)
 end
 for i=r,14 do
  spr(113,i*8,2)
 end

 local o=0
 if(abs(r-8)>2)o+=1
 spr(66+o,0,0)
 spr(98+o,15*8,0)
end
-->8
--screens

title={}

function init_title()
 game.s={u=update_title,d=draw_title}
 title={
  pl=m_player(4,8,true),
  pr=m_player(11,8,false),
 }
 title.pl.t=8
 title.pr.t=8
end

function update_title()
 --if(btnp(4))init_game()
 if(title.pl.t==0)then
  title.pl.x+=1
  title.pr.x-=1
  title.pl.t=8
  title.pr.t=8
 end
 title.pl:animate()
 title.pr:animate()
end

function draw_title()
 cls()
 print("[[title]]",0,0,14)
 title.pl:draw()
 title.pr:draw()
end
__gfx__
00000000000000000000000000099000000990000000000000000000000000000009900000099000000000000000000000000000000000000000000000000000
00000000000000000000000000099000000990000000000000000000000000000009900000099000000000000000000000000000000000000000000000000000
00700700000000000000000000099000000000000000099009900000000000000099990000099000000000000000000000000000000000000000000000000000
00077000000009999990000000099000999999999999999009999999999009999999999999999999000000000000000000000000000000000000000000000000
00077000000099999999000000099000999999999999999009999999999999999990099999999999000000000000000000000000000000000000000000000000
00700700000999000099900000099000000000000000099009900000009999000000000000099000000000000000000000000000000000000000000000000000
00000000000990000009900000099000000990000000000000000000000990000000000000099000000000000000000000000000000000000000000000000000
00000000000990000009900000099000000990000000000000000000000990000000000000099000000000000000000000000000000000000000000000000000
00000000000990000009900000000000000990000009900000000000000990000009900000000000000000000000000000000000000000000000000000000000
00000000000990000009900000000000000990000009900000999900000990000009900000000000000000000000000000000000000000000000000000000000
00000000000999000099900000000000000990000009900000999900000999000099900000000000000000000000000000000000000000000000000000000000
00000000000099999999000099999999990990990009900000099000000099999999000000000000000000000000000000000000000000000000000000000000
00000000000009999990000099999999990990990009900000099000000099999999000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000990000099990000099000000999000099900000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000990000099990000099000000990000009900000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000990000000000000099000000990000009900000000000000000000000000000000000000000000000000000000000
00000000000000000000000000990990009909900000000000000000000000000099099000000000000000000000000000000000000000000000000000000000
00000000000000000000000000990990009909900000000000000000000000000099099000000000000000000000000000000000000000000000000000000000
00000000000000000000000000990990009909900000000000000000000000000099999000000000000000000000000000000000000000000000000000000000
00000000000000000000000000990990009909900000000000000000999009999999999900000000000000000000000000000000000000000000000000000000
00000000000000000000000009909900099099000000000000000000999999999990099900000000000000000000000000000000000000000000000000000000
00000000000000000000000009909900099099000000000000000000099999000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000009909900099099000000000000000000099099000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000009909900099099000000000000000000099099000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000009909900000000000000000000990000009900000000000000000000000000000000000000000000000000000000000
00000000000000000000000099990000009909900000000000000000000990009999900000000000000000000000000000000000000000000000000000000000
00000000000000000000000099999999009909900000000000000000000999999999900000000000000000000000000000000000000000000000000000000000
00000000000000000000000000009999009909900000000000000000000099990099000000000000000000000000000000000000000000000000000000000000
00000000000000000000000099990000099099000000000000000000000099009999000000000000000000000000000000000000000000000000000000000000
00000000000000000000000099999999099099000000000000000000000999999999900000000000000000000000000000000000000000000000000000000000
00000000000000000000000000009999099099000000000000000000000999990009900000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000099099000000000000000000000990000009900000000000000000000000000000000000000000000000000000000000
000aa000000aa000000aa000000aa000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0aaaaaa00aaaaaa00aaaaaa00aaaaaa0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
08888880088888800888888008888880008888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
aa5aa5aaaa5aa5aaaa5aa5aaaa5aa5aa0a5aa5a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa0aaaaaa00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0aaaaaa00aaaaaa00a5555a00aa55aa000a55a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0aaaaaa0000000000aa55aa00aa55aa0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000aa00000aaaa00000aa000000aa000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000ae000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0aaaeee0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0888bbb00088bb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
aa5ae5ee0a5ae5e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
aaaaeeee0aaaeee00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0a5555e000aaee000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0aa55ee0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000ae000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000ee000000ee000000ee000000ee000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0eeeeee00eeeeee00eeeeee00eeeeee0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0bbbbbb00bbbbbb00bbbbbb00bbbbbb000bbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ee5ee5eeee5ee5eeee5ee5eeee5ee5ee0e5ee5e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0eeeeee00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0eeeeee00eeeeee00e5555e00ee55ee000e55e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0eeeeee0000000000ee55ee00ee55ee0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000ee00000eeee00000ee000000ee000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99aa99aaee99ee990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
aa99aa9999ee99ee0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
000a090c1341228b070f000000000000000605031c44288e8d000000000000000000008c0000008b8700000000000000000000839c00008e8d0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000000006131313131305000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000011131313130200000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000300000000000000000000000113131334131305000000000000000000000000000105000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000010413131302000000000000000300061328131302000000000000000006131313131200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000111200000003000000000000000300000000000003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000015000000000000001113131313131312000000000000000000000000000105000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006131313020300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000111200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
